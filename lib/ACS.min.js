function t(t){var i=typeof t;return"object"===i&&(t?"[object Array]"==Object.prototype.toString.call(t)&&(i="array"):i="null"),i}function i(i){return"object"===t(i)}function n(t,i){return t-i}function e(t,i,e){if(null===t||t.length<=i)return null;e||(e=n);for(var s,r,o,h,u,l=0,_=t.length-1;_>l;){for(s=l,r=_,o=s+r>>>1,h=t[o];r>s;)e(t[s],h)>=0?(u=t[r],t[r]=t[s],t[s]=u,r--):s++;e(t[s],h)>0&&s--,s>=i?_=s:l=s+1}return t[i]}function s(t,i,n){return e(t,t.length-i,n)}function r(t){t.visibility=1/(0!==t.length?t.length:1),t.ph=0,t.deltaPh=0}function o(t,i){return t.rank()-i.rank()}function h(t){return this._currentCity!==t&&null!==this.getLink(t)&&!this._visitedCities[t]}var u=require("./random"),l=1,_=5,a=.5,f=100,c=2,d=1,p=function(){};p.prototype._init=function(t,n){if(!i(t))return!1;try{for(var e={},s={},o=[],h=t.links,u=h.length,l=0;u>l;l++){var _=h[l],a=_.src_id.toString(),f=_.dst_id.toString();e[a]||(o.push(a),e[a]=!0),e[f]||(o.push(f),e[f]=!0),r(_),s[_.hash]=_}this._links=h,this._linksMap=s,this._cities=o,this._numOfCities=o.length,this._numOfResults=n}catch(c){return console.error("Failed to initialize ACS data: "+c.toString()),!1}return!0},p.prototype.run=function(t,i){if(!this._init(t,i))return console.error("Malformed ACS data"),null;if(this._numOfAnts=this._numOfCities*d,0===this._numOfAnts)return console.log("Empty ACS data, nothing to do"),[];this._antDistribution={},this._rand=new u;for(var n,e,s,r=0;c>r;r++){n=[];for(var o=0;o<this._numOfAnts;o++)s=this._distributeAnt(),e=new k(s,this._cities,this._linksMap),n.push(e);this._antDistribution={},this._rand=new u,this._updateLinkLevels()}return this._selectBestTours(n,5)},p.prototype._selectBestTours=function(t,i){s(t,i,o);for(var n=[],e=t.length-1;e>=0;e--)e>t.length-1-i&&n.push(t[e]._visitedCitiesIds);return n},p.prototype._distributeAnt=function(){for(var t=0,i=0,n=null;i<this._numOfCities;)if(t=Math.floor(this._rand.uniform(0,this._numOfCities)),n=this._cities[t],i++,!this._antDistribution[n]){this._antDistribution[n]=!0;break}return n},p.prototype._updateLinkLevels=function(){var t,i,n=this._links.length;for(t=0;n>t;t++)i=this._links[t],i.ph+=i.ph*a+i.deltaPh,i.deltaPh=0};var k=function(t,i,n){this._rank=-1,this._length=0,this._cities=i,this._links=n,this._tour=[],this._currentCity=t,this._visitedCities={},this._visitedLinks=[],this._visitedCitiesIds=[],this._sumSelectionLikelihoodCb=function(t,i){return t+this.selectionLikelihood(this.getLink(i))}.bind(this);for(this._visitedCities[t]=!0;this.nextCity(););this.updateVisitedDeltas()};k.prototype.rank=function(){if(-1===this._rank){for(var t=0,i=this._visitedLinks.length,n=0;i>n;n++)t+=this._visitedLinks[n].ph;this._rank=t}return this._rank},k.prototype.getLink=function(t){var i=this._links[this._currentCity+"_"+t];return i||(i=this._links[t+"_"+this._currentCity])?i:null},k.prototype.updateVisitedDeltas=function(){for(var t=this._visitedLinks.length,i=f/this._length,n=0;t>n;n++)this._visitedLinks[n].deltaPh+=i},k.prototype.nextCity=function(){var t,i,n,e,s,r,o=null,l=null,_=this._cities.filter(h,this),a=_.length,f=0;if(0===a)return!1;if(t=this.sumSelectionLikelihood(_),0!==t)for(i=0;a>i;i++)n=_[i],e=this.getLink(n),s=this.selectionLikelihood(e),0!==s&&(r=s/t,r>f&&(f=r,o=n,l=e));return 0===f&&(i=Math.floor((new u).uniform(0,a)),o=_[i],l=this.getLink(o)),null===o||null===l?!1:(this._visitedLinks.push(l),this._length+=l.length,this._visitedCities[o]=!0,this._visitedCitiesIds.push(o),this._currentCity=o,!0)},k.prototype.sumSelectionLikelihood=function(t){return t.reduce(this._sumSelectionLikelihoodCb,0)},k.prototype.selectionLikelihood=function(t){return 0!==t.ph?Math.pow(t.ph,l)*Math.pow(t.visibility,_):0},module.exports=p;